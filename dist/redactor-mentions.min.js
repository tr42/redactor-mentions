(function(){var e,t,n,s,i,o,r;i="undefined"!=typeof exports&&null!==exports?exports:this,e=i.jQuery,r=i.RedactorUtils=null!=(n=i.RedactorUtils)?n:{},t=i.RedactorPlugins=null!=(s=i.RedactorPlugins)?s:{},o=null,e.extend(r,function(){var t;return t=function(e){return e._ran=!1,e._return=null,function(){return e._ran||(e._ran=!0,e._return=e.apply(this,arguments)),e._return}},{once:t,any:function(e){var t,n,s;for(n=0,s=e.length;s>n;n++)if(t=e[n])return!0;return!1},deadLink:function(e){return e.preventDefault()},getCursorInfo:function(){var e,t;return t=window.getSelection(),e=t.getRangeAt(0),{selection:t,range:e,offset:e.startOffset,container:e.startContainer}},loadUsers:t(function(t,n){return e.getJSON(t,function(t){var s,i,r,c,l;for(o=t,c=[],s=i=0,r=t.length;r>i;s=++i)l=t[s],l.$element=e(n?'<li class="user">'+n(l)+"</li>":'<li class="user">\n    <img src="'+l.icon+'" />'+l.username+"  ("+l.name+")\n</li>"),c.push(l.$element[0].user=l);return c})}),filterTest:function(e,t){var n;return t=t.toLowerCase(),n=[e.username.toLowerCase(),e.name.toLowerCase()],r.any(n.map(function(e){return-1!==e.indexOf(t)}))},createMention:function(){var t,n,s,i,o;return t=r.getCursorInfo(),s=e('<a href="#" class="mention">@​</a>'),s.click(r.deadLink),n=t.container.data.slice(0,t.offset),o=t.container.data.slice(t.offset),n=n.slice(0,-1),t.container.data=n,s.insertAfter(t.container),s.after(o),i=document.createRange(),i.setStart(s[0].firstChild,1),i.setEnd(s[0].firstChild,1),t.selection.removeAllRanges(),t.selection.addRange(i)},cursorAfterMentionStart:function(){var e,t,n;return e=r.getCursorInfo(),"#text"!==e.container.nodeName?!1:(t=e.container.data.slice(0,e.offset),t=t.replace(/\u00a0/g," "),t=t.replace(/\u200b/g,""),"@"===(n=t.slice(-2))||" @"===n)}}}()),t.mentions=function(){return{init:function(){return this.mentions.select_state=null,this.mentions.selected=null,this.mentions.$userSelect=null,this.mentions.validateOptions(),r.loadUsers(this.opts.mentions.url,this.opts.mentions.formatUserListItem),this.mentions.setupUserSelect(),this.mentions.setupEditor()},validateOptions:function(){var e,t,n,s,i;for(s=["url","maxUsers"],i=[],e=0,t=s.length;t>e;e++){if(n=s[e],!this.opts.mentions[n])throw"Mention plugin requires option: "+n;i.push(void 0)}return i},setupUserSelect:function(){return this.mentions.select_state=!1,this.mentions.$containerDiv=e('<div class="redactor-mentions-container"></div>'),this.mentions.$containerDiv.hide(),this.mentions.$userSelect=e('<ol class="redactor_ user-select"></ol>'),this.mentions.$containerDiv.append(this.mentions.$userSelect),this.mentions.$userSelect.mousemove(e.proxy(this.mentions.selectMousemove,this)),this.mentions.$userSelect.mousedown(e.proxy(this.mentions.selectClick,this)),this.$editor.after(this.mentions.$containerDiv)},setupEditor:function(){return this.$editor.on("keydown.mentions",e.proxy(this.mentions.editorKeydown,this)),this.$editor.on("mousedown.mentions",e.proxy(this.mentions.selectClick,this))},selectMousemove:function(t){var n;return n=e(t.target),n.hasClass("user")?(this.mentions.selected=this.mentions.$userSelect.children().index(n),this.mentions.paintSelected()):void 0},selectClick:function(e){return this.mentions.select_state?(e.preventDefault(),this.mentions.chooseUser(),this.mentions.closeMention(),this.mentions.setCursorAfterMention(),this.mentions.disableSelect()):void 0},editorKeydown:function(t){var n,s;if(s=this,this.mentions.cursorInMention())switch(t.which){case 27:this.mentions.closeMention(),this.mentions.disableSelect();break;case 9:case 13:t.preventDefault(),n=this.opts.tabFocus,this.opts.tabFocus=!1,this.mentions.select_state&&this.mentions.$userSelect.children().length>0&&this.mentions.chooseUser(),this.mentions.closeMention(),this.mentions.setCursorAfterMention(),this.mentions.disableSelect(),setTimeout(function(){return s.opts.tabFocus=n},0);break;case 38:t.preventDefault(),this.mentions.moveSelectUp();break;case 40:t.preventDefault(),this.mentions.moveSelectDown()}else r.cursorAfterMentionStart()&&(r.createMention(),this.mentions.enableSelect());return setTimeout(e.proxy(this.mentions.updateSelect,this),0)},editorMousedown:function(){return setTimeout(e.proxy(this.mentions.updateSelect,this),0)},positionContainerDiv:function(){var t,n,s;return t=e(this.selection.getNodes()[0]),n=this.$box.offset(),s=t.offset(),this.mentions.$containerDiv.css({left:s.left-n.left,top:s.top-n.top+parseFloat(t.css("line-height"))})},updateSelect:function(){return this.mentions.cursorInMention()?(this.mentions.filterUsers(),this.mentions.positionContainerDiv(),this.mentions.$containerDiv.show()):this.mentions.$containerDiv.hide()},moveSelectUp:function(){return this.mentions.selected>0&&(this.mentions.selected-=1),this.mentions.paintSelected()},moveSelectDown:function(){return this.mentions.selected<this.mentions.$userSelect.children().length-1&&(this.mentions.selected+=1),this.mentions.paintSelected()},enableSelect:function(){var e,t,n;for(this.mentions.select_state=!0,this.mentions.selected=0,e=t=0,n=this.opts.mentions.maxUsers;n>=0?n>t:t>n;e=n>=0?++t:--t)this.mentions.$userSelect.append(o[e].$element);return this.mentions.paintSelected(),this.mentions.positionContainerDiv(),this.mentions.$containerDiv.show()},disableSelect:function(){return this.mentions.select_state=!1,this.mentions.selected=null,this.mentions.$userSelect.children().detach(),this.mentions.$containerDiv.hide()},paintSelected:function(){var t;return t=e("li",this.mentions.$userSelect),t.removeClass("selected"),t.eq(this.mentions.selected).addClass("selected")},chooseUser:function(){var e,t,n;return n=this.mentions.userFromSelected(),t=this.opts.mentions.urlPrefix||"/user/",e=this.mentions.getCurrentMention(),e.attr("href",t+n.username),e.text("@"+n.username),this.opts.mentions.alterUserLink?this.opts.mentions.alterUserLink(e,n):void 0},userFromSelected:function(){return this.mentions.$userSelect.children("li")[this.mentions.selected].user},filterUsers:function(){var e,t,n,s,i;for(this.mentions.$userSelect.children().detach(),t=this.mentions.getFilterString(),e=0,n=0,s=o.length;s>n&&(i=o[n],!(e>=this.opts.mentions.maxUsers));n++)r.filterTest(i,t)&&(this.mentions.$userSelect.append(i.$element),e++);return this.mentions.paintSelected()},getFilterString:function(){var e,t;return t=this.mentions.getCurrentMention(),e=t.text(),e=e.slice(1),e=e.replace(/\u00a0/g," "),e.replace(/\u200b/g,"")},closeMention:function(){var e;return e=this.mentions.getCurrentMention(),e.attr("contenteditable","false")},getCurrentMention:function(){var t,n;if(t=e(this.selection.getCurrent()),t.hasClass("mention"))return t;if(n=t.parents(".mention"),n.length>0)return n.eq(0);throw"There is no current mention."},cursorInMention:function(){var e;try{this.mentions.getCurrentMention().length>0}catch(t){if(e=t,"There is no current mention."===e)return!1;throw e}return!0},setCursorAfterMention:function(){var e,t,n;return e=this.mentions.getCurrentMention(),e.after(" "),n=window.getSelection(),t=document.createRange(),t.setStart(e[0].nextSibling,1),t.setEnd(e[0].nextSibling,1),n.removeAllRanges(),n.addRange(t)}}}}).call(this);